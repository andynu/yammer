(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))c(s);new MutationObserver(s=>{for(const e of s)if(e.type==="childList")for(const p of e.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&c(p)}).observe(document,{childList:!0,subtree:!0});function o(s){const e={};return s.integrity&&(e.integrity=s.integrity),s.referrerPolicy&&(e.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?e.credentials="include":s.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function c(s){if(s.ep)return;s.ep=!0;const e=o(s);fetch(s.href,e)}})();function D(r,a=!1){return window.__TAURI_INTERNALS__.transformCallback(r,a)}async function u(r,a={},o){return window.__TAURI_INTERNALS__.invoke(r,a,o)}var E;(function(r){r.WINDOW_RESIZED="tauri://resize",r.WINDOW_MOVED="tauri://move",r.WINDOW_CLOSE_REQUESTED="tauri://close-requested",r.WINDOW_DESTROYED="tauri://destroyed",r.WINDOW_FOCUS="tauri://focus",r.WINDOW_BLUR="tauri://blur",r.WINDOW_SCALE_FACTOR_CHANGED="tauri://scale-change",r.WINDOW_THEME_CHANGED="tauri://theme-changed",r.WINDOW_CREATED="tauri://window-created",r.WEBVIEW_CREATED="tauri://webview-created",r.DRAG_ENTER="tauri://drag-enter",r.DRAG_OVER="tauri://drag-over",r.DRAG_DROP="tauri://drag-drop",r.DRAG_LEAVE="tauri://drag-leave"})(E||(E={}));async function W(r,a){window.__TAURI_EVENT_PLUGIN_INTERNALS__.unregisterListener(r,a),await u("plugin:event|unlisten",{event:r,eventId:a})}async function g(r,a,o){var c;const s=(c=void 0)!==null&&c!==void 0?c:{kind:"Any"};return u("plugin:event|listen",{event:r,target:s,handler:D(a)}).then(e=>async()=>W(r,e))}document.addEventListener("DOMContentLoaded",async()=>{console.log("Yammer app loaded");const r=document.querySelector(".status-indicator"),a=document.querySelector(".status-text"),o=document.querySelector(".transcript-text"),s=document.getElementById("waveform").getContext("2d");let e={status:"idle",transcript:"",isPartial:!1,pipelineInitialized:!1,isRunning:!1};const p=268,w=40,d=40,I=Math.floor(p/d),A=1;let m=new Array(d).fill(0);function y(){s.clearRect(0,0,p,w);for(let t=0;t<d;t++){const i=m[t],l=Math.max(2,i*w),f=t*I,_=(w-l)/2,h=Math.min(255,Math.floor(i*255+100));s.fillStyle=`rgb(${h}, ${Math.floor(h*.7)}, ${Math.floor(h*.3)})`,s.fillRect(f,_,I-A,l)}}function n(){r.className=`status-indicator ${e.status}`;const t={idle:"Ready",listening:"Listening...",processing:"Processing...",correcting:"Correcting...",done:"Done",error:"Error"};a.textContent=t[e.status]||"Ready",e.transcript?(o.textContent=e.transcript,o.classList.remove("placeholder"),e.isPartial?o.classList.add("partial"):o.classList.remove("partial")):(o.textContent=e.pipelineInitialized?"Press Ctrl+Alt+D to start dictating...":"Initializing...",o.classList.add("placeholder"),o.classList.remove("partial"))}await g("audio-samples",t=>{const i=t.payload;if(Array.isArray(i)&&i.length>0){if(i.length===d)m=i;else{const l=Math.floor(i.length/d);for(let f=0;f<d;f++){const _=f*l;m[f]=Math.abs(i[_]||0)}}y()}}),await g("pipeline-state",t=>{const i=t.payload;console.log("Pipeline state:",i),e.status=i,e.isRunning=i==="listening"||i==="processing"||i==="correcting",i==="listening"&&(e.transcript="",e.isPartial=!1),(i==="done"||i==="error")&&setTimeout(()=>{e.status===i&&(e.status="idle",n())},2e3),n()}),await g("transcript",t=>{const{text:i,isPartial:l}=t.payload;console.log("Transcript:",i,"isPartial:",l),e.transcript=i,e.isPartial=l,n()}),await g("pipeline-error",t=>{const i=t.payload;console.error("Pipeline error:",i),e.status="error",e.transcript=`Error: ${i}`,e.isPartial=!1,n()}),await g("dictation-toggle",async()=>{if(console.log("Dictation toggle hotkey received"),!e.pipelineInitialized){console.log("Pipeline not initialized, initializing first...");try{await R()}catch(t){console.error("Failed to initialize pipeline:",t),e.status="error",e.transcript=`Initialization failed: ${t}`,n();return}}try{const t=await u("toggle_dictation");console.log("Dictation toggled, now running:",t)}catch(t){if(console.error("Toggle dictation error:",t),t.includes("already in progress"))try{await u("stop_dictation")}catch(i){console.error("Stop dictation error:",i)}}}),setInterval(()=>{if(e.status!=="listening"){for(let t=0;t<d;t++)m[t]*=.85;y()}},50);async function R(){console.log("Checking models...");const t=await u("check_models");if(console.log("Model status:",t),!t.whisper.exists)throw new Error(`Whisper model not found at ${t.whisper.path}. Run: yammer download-models`);console.log("Initializing pipeline..."),await u("initialize_pipeline",{whisperModel:null,llmModel:null,useCorrection:t.llm.exists}),e.pipelineInitialized=!0,console.log("Pipeline initialized successfully"),n()}window.setYammerState=t=>{e={...e,...t},n()},window.testWaveform=async()=>{try{await u("simulate_audio"),console.log("Simulated audio sent")}catch(t){console.error("Failed to simulate audio:",t)}},window.testStates=()=>{const t=[{status:"listening",transcript:"",isPartial:!1},{status:"processing",transcript:"This is a test...",isPartial:!0},{status:"correcting",transcript:"This is a test transcript",isPartial:!1},{status:"done",transcript:"This is a test transcript.",isPartial:!1},{status:"idle",transcript:"",isPartial:!1}];let i=0;const l=setInterval(()=>{window.setYammerState(t[i]),console.log("State:",t[i].status),i++,i>=t.length&&clearInterval(l)},2e3)},n(),y(),setTimeout(async()=>{try{await R()}catch(t){console.error("Auto-initialization failed:",t),e.transcript=`Ready. ${t.message||t}`,n()}},500)});
